<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>HSMA - Geographic Modelling and Visualisation - 28&nbsp; Using code to solve facility location problems</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./fl_site_combinations.html" rel="prev">
<link href="./resources/logos/hsma_logo_transparent_background_large.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script type="text/javascript">
window.PlotlyConfig = {MathJaxConfig: 'local'};
if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}
if (typeof require !== 'undefined') {
require.undef("plotly");
requirejs.config({
    paths: {
        'plotly': ['https://cdn.plot.ly/plotly-2.32.0.min']
    }
});
require(['plotly'], function(Plotly) {
    window._Plotly = Plotly;
});
}
</script>



<link rel="stylesheet" href="include/webex.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">HSMA - Geographic Modelling and Visualisation</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/hsma-programme/hsma6_geographic_optimisation_and_visualisation_book"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./intro_facility_location.html">Part 5 - Facility Location Problems</a></li><li class="breadcrumb-item"><a href="./fl_problems_coding.html"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Using code to solve facility location problems</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./resources/logos/hsma_logo_transparent_background_large.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Welcome!</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./what_geographic_problems_health_etc.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Types of Geographic Problems</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Part 1 - Geographic Concepts and Terms</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./concepts_and_terms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geographical Concepts and Terminology</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ct_crs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Projections and Coordinate Reference Systems</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ct_filetypes.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Geographic Data Filetypes</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./the_importance_of_standardisation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Standardisation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Part 2 - Mapping in QGIS</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction_mapping_with_qgis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Mapping in QGIS</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./qgis_setup.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Getting QGIS Ready to Use</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./qgis_basemaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Adding a basemap in QGIS</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./qgis_point_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Visualising Point Data in QGIS</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./qgis_choropleth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Creating Choropleths in QGIS - Importing Boundaries</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./qgis_choropleths_joining.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Choropleths in QGIS - Joining Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./qgis_filtering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Filtering Data in QGIS</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./qgis_print_layouts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Print Layouts in QGIS</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./qgis_exercises.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Exercises - QGIS</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Part 3 - Mapping in Python</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./why_python_mapping.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Why use python for maps?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_geopandas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Working With Travel Time Data in Python - the geopandas package</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_geopandas_reading_files.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Reading files with Geopandas</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_geopandas_matplotlib.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Static Maps with Matplotlib</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_geopandas_folium_intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Interactive Maps - Setting Up</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_geopandas_folium_point_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Interactive Maps - Point Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./python_geopandas_folium_choropleths.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Interactive Maps - Choropleths</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Part 4 - Working with Travel Times</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mapping_travel_times.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">What aspects can travel times help me with?</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mtt_mapping_travel_times_python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Visualising Travel Times in Python</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mtt_travel_time_apis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Lookup Up Travel Times Using APIs</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Part 5 - Facility Location Problems</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro_facility_location.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">An Introduction to Facility Location Problems</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fl_site_combinations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Calculating combinations of sites</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fl_problems_coding.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Using code to solve facility location problems</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#demand-data" id="toc-demand-data" class="nav-link active" data-scroll-target="#demand-data"><span class="header-section-number">28.1</span> Demand data</a></li>
  <li><a href="#evaluating-the-weighted-average-travel-time" id="toc-evaluating-the-weighted-average-travel-time" class="nav-link" data-scroll-target="#evaluating-the-weighted-average-travel-time"><span class="header-section-number">28.2</span> Evaluating the weighted average travel time</a>
  <ul class="collapse">
  <li><a href="#setting-up-an-instance-of-this-class" id="toc-setting-up-an-instance-of-this-class" class="nav-link" data-scroll-target="#setting-up-an-instance-of-this-class"><span class="header-section-number">28.2.1</span> Setting up an instance of this class</a></li>
  <li><a href="#outputs" id="toc-outputs" class="nav-link" data-scroll-target="#outputs"><span class="header-section-number">28.2.2</span> Outputs</a></li>
  <li><a href="#obtaining-solution-metrics-in-a-loop" id="toc-obtaining-solution-metrics-in-a-loop" class="nav-link" data-scroll-target="#obtaining-solution-metrics-in-a-loop"><span class="header-section-number">28.2.3</span> Obtaining solution metrics in a loop</a></li>
  <li><a href="#plotting-the-best-solution" id="toc-plotting-the-best-solution" class="nav-link" data-scroll-target="#plotting-the-best-solution"><span class="header-section-number">28.2.4</span> Plotting the best solution</a></li>
  <li><a href="#plotting-all-solutions" id="toc-plotting-all-solutions" class="nav-link" data-scroll-target="#plotting-all-solutions"><span class="header-section-number">28.2.5</span> Plotting all solutions</a></li>
  <li><a href="#other-ways-to-display-the-output" id="toc-other-ways-to-display-the-output" class="nav-link" data-scroll-target="#other-ways-to-display-the-output"><span class="header-section-number">28.2.6</span> Other ways to display the output</a></li>
  </ul></li>
  <li><a href="#full-code-example" id="toc-full-code-example" class="nav-link" data-scroll-target="#full-code-example"><span class="header-section-number">28.3</span> Full Code Example</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./intro_facility_location.html">Part 5 - Facility Location Problems</a></li><li class="breadcrumb-item"><a href="./fl_problems_coding.html"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Using code to solve facility location problems</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Using code to solve facility location problems</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Right - now we know the combinations we want to test and how long it takes to get to each clinic location, we’ll need some sort of demand figures.</p>
<section id="demand-data" class="level2" data-number="28.1">
<h2 data-number="28.1" class="anchored" data-anchor-id="demand-data"><span class="header-section-number">28.1</span> Demand data</h2>
<p>Chances are your demand isn’t spread evenly across your potential service user catchment area.</p>
<ul>
<li>Maybe certain LSOAs have more people of childbearing age, so maternity and paediatric services will get more demand from those areas</li>
<li>Maybe certain LSOAs have an older population, so stroke services are more centred around there</li>
<li>Maybe other LSOAs have a higher incidence of obesity, so you might expect more demand for type 2 diabetes services and retinopathy clinics</li>
</ul>
<p>Your demand data can be formatted quite simply!</p>
<p>You just want to make sure that you’re using the same level of location data as in your travel matrix (e.g.&nbsp;they need to both use LSOA, or both use postcode sectors - not a mixture)</p>
<p><img src="assets/2024-06-24-19-17-30.png" class="img-fluid"></p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>You might use historic demand figures as your starting point.</p>
<p>But always consider…</p>
<ul>
<li>If you seem to have areas with no historic demand, is this actually a pattern, or is it just that the historic numbers are small and there’s an element of chance?</li>
<li>Is there some preexisting bias or issue with access that you might be perpetuating by using the historic figures?</li>
</ul>
<p>How can you deal with these issues?</p>
<p>If you’re using historic data, can you bring in more years?</p>
<p>Alternatively, you could explore what happens when you just weight demand by the number of people in each LSOA.</p>
<p>If your service only covers a certain age range, you can find LSOA-level figures estimating the proportion of the population in that age group.</p>
<p><img src="assets/2024-06-24-19-18-13.png" class="img-fluid"></p>
<p>You might also just make predictions of demand based off something else. - Number of people in a target age demographic or of a particular gender in your LSOAs, multiplied by some factor - (e.g.&nbsp;20% of women aged 18-34)</p>
<p>Just always consider whether what you’re doing is</p>
<ul>
<li>appropriate</li>
<li>sensible</li>
<li>transparent</li>
<li>justifiable</li>
</ul>
<p>Make it clear what data you have used and why!</p>
<p>Make the limitations of your conclusions explicit.</p>
</div>
</div>
</section>
<section id="evaluating-the-weighted-average-travel-time" class="level2" data-number="28.2">
<h2 data-number="28.2" class="anchored" data-anchor-id="evaluating-the-weighted-average-travel-time"><span class="header-section-number">28.2</span> Evaluating the weighted average travel time</h2>
<p>Right! We’ve got everything we need - except a way to evaluate the weighted average travel time…</p>
<p>Cast your mind back many many slides - when we present our options, we want to give more weight to the travel times from areas that have higher demand.</p>
<p><img src="assets/2024-06-24-19-19-04.png" class="img-fluid"></p>
<p>Let’s write some code to do this.</p>
<p>It’s something we’re going to want to reuse quite a lot - so we can turn it into a class with…</p>
<p><strong>Attributes</strong></p>
<ul>
<li>our travel dataframe</li>
<li>our demand dataframe</li>
</ul>
<p><strong>Methods</strong></p>
<ul>
<li>Evaluate a solution
<ul>
<li>Limit the travel dataframe to a subset of candidate locations</li>
<li>Work out the smallest value per location (the ‘minimum cost’)</li>
<li>Return a dataframe with demand and min cost per region</li>
</ul></li>
<li>Return the weighted average for the solution</li>
<li>Return the unweighted average for the solution</li>
<li>Return the maximum travel time for any locations in the solution</li>
</ul>
<div class="callout-info">
<p>The FacilityLocationObjective code is modified from the Metapy library created by Tom Monks</p>
<p><a href="https://github.com/health-data-science-OR/healthcare-logistics/tree/master/optimisation/metapy">https://github.com/health-data-science-OR/healthcare-logistics/tree/master/optimisation/metapy</a></p>
</div>
<section id="the-init-method" class="level4" data-number="28.2.0.1">
<h4 data-number="28.2.0.1" class="anchored" data-anchor-id="the-init-method"><span class="header-section-number">28.2.0.1</span> The <strong>init</strong> method</h4>
<div id="97946124" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FacilityLocationObjective:</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, demand, travel_matrix, merge_col, demand_col):</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">        Store the demand and travel times</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">            demand: pd.DataFrame:</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">            travel_matrix: pd.DataFrame:</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.demand <span class="op">=</span> demand.set_index(merge_col)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.travel_matrix <span class="op">=</span> travel_matrix.set_index(merge_col)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.demand_col <span class="op">=</span> demand_col</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>demand</strong> is our dataframe containing demand sources (e.g.&nbsp;LSOAs) as rows and the demand (e.g.&nbsp;yearly patients coming from that LSOA) as the single column</p>
<p><strong>merge_col</strong> is the name of the column that is consistent between our demand and travel dataframes</p>
<p><strong>travel_matrix</strong> is the dataframe with demand sources as rows and potential service locations as columns, with the travel cost (time) as the values in the cells</p>
<p><strong>demand_col</strong> is a string referring to the column that contains the demand value in the demand dataframe</p>
</section>
<section id="the-evaluate_solution-method" class="level4" data-number="28.2.0.2">
<h4 data-number="28.2.0.2" class="anchored" data-anchor-id="the-evaluate_solution-method"><span class="header-section-number">28.2.0.2</span> The evaluate_solution method</h4>
<p>This method, given a list of sites in the form of their column indices (e.g.&nbsp;[1, 4, 5] for sites 2, 5 and 6), will return a dataframe with the demand and minimum travel time per row for this potential solution.</p>
<div id="6e375595" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_solution(<span class="va">self</span>, site_list):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">            site_list: list: column indices of solution to evaluate</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">                            (to apply to travel matrix)</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">            Pandas dataframe to pass to evaluation functions</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        active_facilities <span class="op">=</span> <span class="va">self</span>.travel_matrix.iloc[:, site_list].copy()</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assume travel to closest facility</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Need to drop the column that contains</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        active_facilities[<span class="st">'min_cost'</span>] <span class="op">=</span> active_facilities.<span class="bu">min</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge demand and travel times into a single DataFrame</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        problem <span class="op">=</span> <span class="va">self</span>.demand.merge(active_facilities,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                                    left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>                                    how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> problem.reset_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="the-generate_solution_metrics-method" class="level4" data-number="28.2.0.3">
<h4 data-number="28.2.0.3" class="anchored" data-anchor-id="the-generate_solution_metrics-method"><span class="header-section-number">28.2.0.3</span> The generate_solution_metrics method</h4>
<p>This method, given a list of sites in the form of their column indices (e.g.&nbsp;[1, 4, 5] for sites 2, 5 and 6) - Runs the evaluate_solution method - Returns a range of metrics relating to the</p>
<div id="cf51924d" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_solution_metrics(<span class="va">self</span>, site_list):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">        Calculates the weighted average travel time for selected sites</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">            site_list: list or np.array: A list of site IDs as a list or array (e.g. [0, 3, 4])</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">            merge_col: string: The column name to use for merging the data.</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">            n_patients_or_referrals_col: string: The column name to use for the number of patients or referrals.</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">            A tuple containing the problem and the maximum travel time.</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>        problem <span class="op">=</span> <span class="va">self</span>.evaluate_solution(site_list)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return weighted average</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        weighted_average <span class="op">=</span> np.average(problem[<span class="st">'min_cost'</span>], weights<span class="op">=</span>problem[<span class="va">self</span>.demand_col])</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        unweighted_average <span class="op">=</span> np.average(problem[<span class="st">'min_cost'</span>])</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        max_travel <span class="op">=</span> np.<span class="bu">max</span>(problem[<span class="st">'min_cost'</span>])</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">'site_indices'</span>: site_list,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">'site_names'</span>: <span class="st">", "</span>.join(<span class="va">self</span>.travel_matrix.columns[site_list].tolist()),</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">'weighted_average'</span>: weighted_average,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">'unweighted_average'</span>: unweighted_average,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">'max'</span>: max_travel,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">'problem_df'</span>: problem</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>        }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>:::{.callout-tip collapse=“True”} ### Click here to view the whole class</p>
<div id="5d20f0da" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tweaked WeightedAverageObjective from Metapy package</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/health-data-science-OR/healthcare-logistics/tree/master/optimisation/metapy</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Credit: Tom Monks</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FacilityLocationObjective:</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Encapsulates logic for calculation of</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">    metrics in a simple facility location problem</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Demand and travel matrices must have a common column</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">    demand: pd.dataframe:  Two column dataframe. One column should be labels for the</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">    demand locations (e.g. LSOA identifiers, postcodes). Second column should contain</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">    demand figures of some kind (e.g. number of historical cases)</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">    If demand assumed to be equal, all values in this column could be 1.</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co">    travel_matrix: pd.dataframe: dataframe with columns representing sites</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co">    and rows representing locations demand will come from.</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">    One column should be labels for the demand locations (e.g. LSOA identifiers, postcodes).</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">    All other values will be either distance or time in float form.</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">    No additional columns of information must be included or they will be used as part of the</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co">    calculation of the lowest-cost solution, which may lead to incorrect results.</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, demand, travel_matrix, merge_col, demand_col):</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co">        Store the demand and travel times</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co">            demand: pd.DataFrame:</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co">            travel_matrix: pd.DataFrame:</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.demand <span class="op">=</span> demand.set_index(merge_col)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.travel_matrix <span class="op">=</span> travel_matrix.set_index(merge_col)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.demand_col <span class="op">=</span> demand_col</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_solution(<span class="va">self</span>, site_list):</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co">        Calculates the</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co">            site_list: list: column indices of solution to evaluate</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="co">                            (to apply to travel matrix)</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="co">            Pandas dataframe to pass to evaluation functions</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        active_facilities <span class="op">=</span> <span class="va">self</span>.travel_matrix.iloc[:, site_list].copy()</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assume travel to closest facility</span></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Need to drop the column that contains</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>        active_facilities[<span class="st">'min_cost'</span>] <span class="op">=</span> active_facilities.<span class="bu">min</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge demand and travel times into a single DataFrame</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        problem <span class="op">=</span> <span class="va">self</span>.demand.merge(active_facilities,</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>                                    left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>                                    how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> problem.reset_index()</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_solution_metrics(<span class="va">self</span>, site_list):</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a><span class="co">        Calculates the weighted average travel time for selected sites</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a><span class="co">            site_list: list or np.array: A list of site IDs as a list or array (e.g. [0, 3, 4])</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a><span class="co">            merge_col: string: The column name to use for merging the data.</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a><span class="co">            n_patients_or_referrals_col: string: The column name to use for the number of patients or referrals.</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a><span class="co">            A tuple containing the problem and the maximum travel time.</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        problem <span class="op">=</span> <span class="va">self</span>.evaluate_solution(site_list)</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return weighted average</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>        weighted_average <span class="op">=</span> np.average(problem[<span class="st">'min_cost'</span>], weights<span class="op">=</span>problem[<span class="va">self</span>.demand_col])</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>        unweighted_average <span class="op">=</span> np.average(problem[<span class="st">'min_cost'</span>])</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        max_travel <span class="op">=</span> np.<span class="bu">max</span>(problem[<span class="st">'min_cost'</span>])</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>            <span class="st">'site_indices'</span>: site_list,</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>            <span class="st">'site_names'</span>: <span class="st">", "</span>.join(<span class="va">self</span>.travel_matrix.columns[site_list].tolist()),</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>            <span class="st">'weighted_average'</span>: weighted_average,</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>            <span class="st">'unweighted_average'</span>: unweighted_average,</span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>            <span class="st">'max'</span>: max_travel,</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>            <span class="st">'problem_df'</span>: problem</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>        }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="setting-up-an-instance-of-this-class" class="level3" data-number="28.2.1">
<h3 data-number="28.2.1" class="anchored" data-anchor-id="setting-up-an-instance-of-this-class"><span class="header-section-number">28.2.1</span> Setting up an instance of this class</h3>
<p>Let’s first import the packages we will need throughout this section.</p>
<div id="e1ffbe37" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We need to - import a dataset of demand - import (or create) a geodataframe of site locations - and import (or create) a travel matrix for this combination of sites and demand sources</p>
<div id="3674357e" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>brighton_demand <span class="op">=</span> pd.read_csv(<span class="st">"https://raw.githubusercontent.com/hsma-programme/h6_3d_facility_location_problems/main/h6_3d_facility_location_problems/example_code/brighton_demand.csv"</span>).drop(columns<span class="op">=</span>[<span class="st">"Unnamed: 0"</span>])</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>brighton_demand.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LSOA</th>
<th data-quarto-table-cell-role="th">demand</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Brighton and Hove 027E</td>
<td>3627</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Brighton and Hove 027F</td>
<td>2323</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Brighton and Hove 027A</td>
<td>2596</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Brighton and Hove 029E</td>
<td>3132</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Brighton and Hove 029D</td>
<td>2883</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="1d8a11c4" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>brighton_sites <span class="op">=</span> geopandas.read_file(<span class="st">"https://raw.githubusercontent.com/hsma-programme/h6_3d_facility_location_problems/main/h6_3d_facility_location_problems/example_code/brighton_sites.geojson"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>brighton_sites.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">site</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Site 1</td>
<td>POINT (-0.19544 50.84511)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Site 2</td>
<td>POINT (-0.13365 50.84435)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Site 3</td>
<td>POINT (-0.10763 50.83347)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Site 4</td>
<td>POINT (-0.17652 50.83075)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Site 5</td>
<td>POINT (-0.11961 50.86597)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<div id="4642d126" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>brighton_travel <span class="op">=</span> pd.read_csv(<span class="st">"https://raw.githubusercontent.com/hsma-programme/h6_3d_facility_location_problems/main/h6_3d_facility_location_problems/example_code/brighton_travel_matrix_driving.csv"</span>).drop(columns<span class="op">=</span>[<span class="st">"Unnamed: 0"</span>])</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>brighton_travel.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LSOA</th>
<th data-quarto-table-cell-role="th">Site 1</th>
<th data-quarto-table-cell-role="th">Site 2</th>
<th data-quarto-table-cell-role="th">Site 3</th>
<th data-quarto-table-cell-role="th">Site 4</th>
<th data-quarto-table-cell-role="th">Site 5</th>
<th data-quarto-table-cell-role="th">Site 6</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Brighton and Hove 027E</td>
<td>773.93</td>
<td>527.69</td>
<td>444.29</td>
<td>491.85</td>
<td>607.54</td>
<td>554.91</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Brighton and Hove 027F</td>
<td>757.39</td>
<td>499.11</td>
<td>517.57</td>
<td>561.07</td>
<td>578.97</td>
<td>538.37</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Brighton and Hove 027A</td>
<td>763.24</td>
<td>601.38</td>
<td>517.98</td>
<td>410.40</td>
<td>681.23</td>
<td>557.35</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Brighton and Hove 029E</td>
<td>743.62</td>
<td>651.72</td>
<td>660.36</td>
<td>379.72</td>
<td>731.58</td>
<td>557.58</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Brighton and Hove 029D</td>
<td>665.85</td>
<td>664.65</td>
<td>658.20</td>
<td>313.00</td>
<td>744.50</td>
<td>570.51</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Finally, we bring in our LSOA boundaries for plotting later.</p>
<div id="4ef7d417" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>lsoa_boundaries <span class="op">=</span> geopandas.read_file(<span class="st">"https://raw.githubusercontent.com/hsma-programme/h6_3d_facility_location_problems/main/h6_3d_facility_location_problems/example_code/LSOA_2011_Boundaries_Super_Generalised_Clipped_BSC_EW_V4.geojson"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>lsoa_boundaries.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">FID</th>
<th data-quarto-table-cell-role="th">LSOA11CD</th>
<th data-quarto-table-cell-role="th">LSOA11NM</th>
<th data-quarto-table-cell-role="th">LSOA11NMW</th>
<th data-quarto-table-cell-role="th">BNG_E</th>
<th data-quarto-table-cell-role="th">BNG_N</th>
<th data-quarto-table-cell-role="th">LONG</th>
<th data-quarto-table-cell-role="th">LAT</th>
<th data-quarto-table-cell-role="th">GlobalID</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>E01000001</td>
<td>City of London 001A</td>
<td>City of London 001A</td>
<td>532123</td>
<td>181632</td>
<td>-0.097140</td>
<td>51.51816</td>
<td>a758442e-7679-45d0-95a8-ed4c968ecdaa</td>
<td>POLYGON ((532282.629 181906.496, 532248.250 18...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>E01000002</td>
<td>City of London 001B</td>
<td>City of London 001B</td>
<td>532480</td>
<td>181715</td>
<td>-0.091970</td>
<td>51.51882</td>
<td>861dbb53-dfaf-4f57-be96-4527e2ec511f</td>
<td>POLYGON ((532746.814 181786.892, 532248.250 18...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>E01000003</td>
<td>City of London 001C</td>
<td>City of London 001C</td>
<td>532239</td>
<td>182033</td>
<td>-0.095320</td>
<td>51.52174</td>
<td>9f765b55-2061-484a-862b-fa0325991616</td>
<td>POLYGON ((532293.068 182068.422, 532419.592 18...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>E01000005</td>
<td>City of London 001E</td>
<td>City of London 001E</td>
<td>533581</td>
<td>181283</td>
<td>-0.076270</td>
<td>51.51468</td>
<td>a55c4c31-ef1c-42fc-bfa9-07c8f2025928</td>
<td>POLYGON ((533604.245 181418.129, 533743.689 18...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>E01000006</td>
<td>Barking and Dagenham 016A</td>
<td>Barking and Dagenham 016A</td>
<td>544994</td>
<td>184274</td>
<td>0.089317</td>
<td>51.53875</td>
<td>9cdabaa8-d9bd-4a94-bb3b-98a933ceedad</td>
<td>POLYGON ((545271.918 184183.948, 545296.314 18...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>We will then pass the travel and demand datasets into our <code>FacilityLocationObjective</code>; the site df will be used afterwards.</p>
<div id="5712ed6a" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>location_problem_brighton <span class="op">=</span> FacilityLocationObjective(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    demand<span class="op">=</span>brighton_demand,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    travel_matrix<span class="op">=</span>brighton_travel,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    merge_col<span class="op">=</span><span class="st">"LSOA"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    demand_col<span class="op">=</span><span class="st">"demand"</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><img src="assets/2024-06-24-19-27-49.png" class="img-fluid"></p>
</section>
<section id="outputs" class="level3" data-number="28.2.2">
<h3 data-number="28.2.2" class="anchored" data-anchor-id="outputs"><span class="header-section-number">28.2.2</span> Outputs</h3>
<section id="evaluate_solution" class="level4" data-number="28.2.2.1">
<h4 data-number="28.2.2.1" class="anchored" data-anchor-id="evaluate_solution"><span class="header-section-number">28.2.2.1</span> evaluate_solution</h4>
<p>This is the output of the evaluate_solution method.</p>
<p><img src="assets/2024-06-24-19-29-00.png" class="img-fluid"></p>
<p>And now we can easily pass in a range of solutions - including with different numbers of sites.</p>
<p>Note the column names changing to reflect the site indices we are passing in.</p>
<p><img src="assets/2024-06-24-19-29-31.png" class="img-fluid"></p>
<p>Now we bring in our code from an earlier chapter to calculate every possible combination of a certain number of facilities.</p>
<div id="55e45be7" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> combinations</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> all_combinations(n_facilities, p):</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    facility <span class="op">=</span> np.arange(n_facilities, dtype<span class="op">=</span>np.uint8)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [np.array(a) <span class="cf">for</span> a <span class="kw">in</span> combinations(facility, p)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could even loop through this to find every combination with every possible number of facilities…</p>
<div id="6554a810" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>possible_combinations_brighton <span class="op">=</span> all_combinations(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">len</span>(location_problem_brighton.travel_matrix.columns),</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>possible_combinations_brighton</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>[array([0, 1, 2, 3], dtype=uint8),
 array([0, 1, 2, 4], dtype=uint8),
 array([0, 1, 2, 5], dtype=uint8),
 array([0, 1, 3, 4], dtype=uint8),
 array([0, 1, 3, 5], dtype=uint8),
 array([0, 1, 4, 5], dtype=uint8),
 array([0, 2, 3, 4], dtype=uint8),
 array([0, 2, 3, 5], dtype=uint8),
 array([0, 2, 4, 5], dtype=uint8),
 array([0, 3, 4, 5], dtype=uint8),
 array([1, 2, 3, 4], dtype=uint8),
 array([1, 2, 3, 5], dtype=uint8),
 array([1, 2, 4, 5], dtype=uint8),
 array([1, 3, 4, 5], dtype=uint8),
 array([2, 3, 4, 5], dtype=uint8)]</code></pre>
</div>
</div>
</section>
</section>
<section id="obtaining-solution-metrics-in-a-loop" class="level3" data-number="28.2.3">
<h3 data-number="28.2.3" class="anchored" data-anchor-id="obtaining-solution-metrics-in-a-loop"><span class="header-section-number">28.2.3</span> Obtaining solution metrics in a loop</h3>
<p>Now we can loop through every possible combination and save the outputs.</p>
<div id="182879ef" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>outputs <span class="op">=</span> []</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> possible_solution <span class="kw">in</span> possible_combinations_brighton:</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    outputs.append(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>        location_problem_brighton.generate_solution_metrics(</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        possible_solution</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And easily turn our list of dictionaries into a dataframe!</p>
<div id="365a5242" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(outputs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">site_indices</th>
<th data-quarto-table-cell-role="th">site_names</th>
<th data-quarto-table-cell-role="th">weighted_average</th>
<th data-quarto-table-cell-role="th">unweighted_average</th>
<th data-quarto-table-cell-role="th">max</th>
<th data-quarto-table-cell-role="th">problem_df</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>[0, 1, 2, 3]</td>
<td>Site 1, Site 2, Site 3, Site 4</td>
<td>313.257086</td>
<td>312.565758</td>
<td>1001.33</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>[0, 1, 2, 4]</td>
<td>Site 1, Site 2, Site 3, Site 5</td>
<td>374.295378</td>
<td>370.452061</td>
<td>1001.33</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>[0, 1, 2, 5]</td>
<td>Site 1, Site 2, Site 3, Site 6</td>
<td>368.551505</td>
<td>355.460000</td>
<td>1001.33</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>[0, 1, 3, 4]</td>
<td>Site 1, Site 2, Site 4, Site 5</td>
<td>397.907659</td>
<td>385.938061</td>
<td>1302.58</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>[0, 1, 3, 5]</td>
<td>Site 1, Site 2, Site 4, Site 6</td>
<td>410.033802</td>
<td>388.522909</td>
<td>1371.46</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>[0, 1, 4, 5]</td>
<td>Site 1, Site 2, Site 5, Site 6</td>
<td>460.215392</td>
<td>436.115273</td>
<td>1302.58</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>[0, 2, 3, 4]</td>
<td>Site 1, Site 3, Site 4, Site 5</td>
<td>304.810704</td>
<td>306.939576</td>
<td>1001.33</td>
<td>LSOA demand Site 1 ...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>[0, 2, 3, 5]</td>
<td>Site 1, Site 3, Site 4, Site 6</td>
<td>313.630625</td>
<td>311.418303</td>
<td>1001.33</td>
<td>LSOA demand Site 1 ...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>[0, 2, 4, 5]</td>
<td>Site 1, Site 3, Site 5, Site 6</td>
<td>363.242023</td>
<td>354.221818</td>
<td>1001.33</td>
<td>LSOA demand Site 1 ...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>[0, 3, 4, 5]</td>
<td>Site 1, Site 4, Site 5, Site 6</td>
<td>414.657901</td>
<td>393.878606</td>
<td>1302.58</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>[1, 2, 3, 4]</td>
<td>Site 2, Site 3, Site 4, Site 5</td>
<td>316.865395</td>
<td>319.753939</td>
<td>1001.33</td>
<td>LSOA demand Site 2 ...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>[1, 2, 3, 5]</td>
<td>Site 2, Site 3, Site 4, Site 6</td>
<td>311.756166</td>
<td>304.151576</td>
<td>1001.33</td>
<td>LSOA demand Site 2 ...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>[1, 2, 4, 5]</td>
<td>Site 2, Site 3, Site 5, Site 6</td>
<td>379.697853</td>
<td>370.415455</td>
<td>1001.33</td>
<td>LSOA demand Site 2 ...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>[1, 3, 4, 5]</td>
<td>Site 2, Site 4, Site 5, Site 6</td>
<td>399.681921</td>
<td>382.101333</td>
<td>1302.58</td>
<td>LSOA demand Site 2 S...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>[2, 3, 4, 5]</td>
<td>Site 3, Site 4, Site 5, Site 6</td>
<td>306.446684</td>
<td>302.913394</td>
<td>1001.33</td>
<td>LSOA demand Site 3 ...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>Then it’s easy to find the best combinations and tidy up the output table.</p>
<div id="3060ad54" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(outputs).sort_values(<span class="st">'weighted_average'</span>).<span class="bu">round</span>(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">site_indices</th>
<th data-quarto-table-cell-role="th">site_names</th>
<th data-quarto-table-cell-role="th">weighted_average</th>
<th data-quarto-table-cell-role="th">unweighted_average</th>
<th data-quarto-table-cell-role="th">max</th>
<th data-quarto-table-cell-role="th">problem_df</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>[0, 2, 3, 4]</td>
<td>Site 1, Site 3, Site 4, Site 5</td>
<td>304.8</td>
<td>306.9</td>
<td>1001.3</td>
<td>LSOA demand Site 1 ...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">14</td>
<td>[2, 3, 4, 5]</td>
<td>Site 3, Site 4, Site 5, Site 6</td>
<td>306.4</td>
<td>302.9</td>
<td>1001.3</td>
<td>LSOA demand Site 3 ...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">11</td>
<td>[1, 2, 3, 5]</td>
<td>Site 2, Site 3, Site 4, Site 6</td>
<td>311.8</td>
<td>304.2</td>
<td>1001.3</td>
<td>LSOA demand Site 2 ...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>[0, 1, 2, 3]</td>
<td>Site 1, Site 2, Site 3, Site 4</td>
<td>313.3</td>
<td>312.6</td>
<td>1001.3</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>[0, 2, 3, 5]</td>
<td>Site 1, Site 3, Site 4, Site 6</td>
<td>313.6</td>
<td>311.4</td>
<td>1001.3</td>
<td>LSOA demand Site 1 ...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">10</td>
<td>[1, 2, 3, 4]</td>
<td>Site 2, Site 3, Site 4, Site 5</td>
<td>316.9</td>
<td>319.8</td>
<td>1001.3</td>
<td>LSOA demand Site 2 ...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>[0, 2, 4, 5]</td>
<td>Site 1, Site 3, Site 5, Site 6</td>
<td>363.2</td>
<td>354.2</td>
<td>1001.3</td>
<td>LSOA demand Site 1 ...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>[0, 1, 2, 5]</td>
<td>Site 1, Site 2, Site 3, Site 6</td>
<td>368.6</td>
<td>355.5</td>
<td>1001.3</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>[0, 1, 2, 4]</td>
<td>Site 1, Site 2, Site 3, Site 5</td>
<td>374.3</td>
<td>370.5</td>
<td>1001.3</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">12</td>
<td>[1, 2, 4, 5]</td>
<td>Site 2, Site 3, Site 5, Site 6</td>
<td>379.7</td>
<td>370.4</td>
<td>1001.3</td>
<td>LSOA demand Site 2 ...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>[0, 1, 3, 4]</td>
<td>Site 1, Site 2, Site 4, Site 5</td>
<td>397.9</td>
<td>385.9</td>
<td>1302.6</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>[1, 3, 4, 5]</td>
<td>Site 2, Site 4, Site 5, Site 6</td>
<td>399.7</td>
<td>382.1</td>
<td>1302.6</td>
<td>LSOA demand Site 2 S...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>[0, 1, 3, 5]</td>
<td>Site 1, Site 2, Site 4, Site 6</td>
<td>410.0</td>
<td>388.5</td>
<td>1371.5</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>[0, 3, 4, 5]</td>
<td>Site 1, Site 4, Site 5, Site 6</td>
<td>414.7</td>
<td>393.9</td>
<td>1302.6</td>
<td>LSOA demand Site 1 S...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>[0, 1, 4, 5]</td>
<td>Site 1, Site 2, Site 5, Site 6</td>
<td>460.2</td>
<td>436.1</td>
<td>1302.6</td>
<td>LSOA demand Site 1 S...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
<p>And, since we stored the combinations in our dataframe too, we can easily pull this out by chaining together a few steps.</p>
<div id="fd60daba" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(outputs).sort_values(<span class="st">'weighted_average'</span>).head(<span class="dv">1</span>)[<span class="st">'site_names'</span>].values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>array(['Site 1, Site 3, Site 4, Site 5'], dtype=object)</code></pre>
</div>
</div>
</section>
<section id="plotting-the-best-solution" class="level3" data-number="28.2.4">
<h3 data-number="28.2.4" class="anchored" data-anchor-id="plotting-the-best-solution"><span class="header-section-number">28.2.4</span> Plotting the best solution</h3>
<p>We can now put this all together with the map plotting skills we’ve learned over the last few sessions.</p>
<p>When plotting our sites as well, we can ensure we are only plotting the sites included in our solution - see the highlighted sections of the code below.</p>
<p><img src="assets/2024-06-24-22-00-36.png" class="img-fluid"></p>
<div class="callout-info">
<p>Let’s explore what the output of the first line of code is:</p>
<div id="d1e5ca31" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>best_solution <span class="op">=</span> pd.DataFrame(outputs).sort_values(<span class="st">'weighted_average'</span>).head(<span class="dv">1</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>best_solution_df <span class="op">=</span> best_solution[<span class="st">'problem_df'</span>].values[<span class="dv">0</span>]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>best_solution_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LSOA</th>
<th data-quarto-table-cell-role="th">demand</th>
<th data-quarto-table-cell-role="th">Site 1</th>
<th data-quarto-table-cell-role="th">Site 3</th>
<th data-quarto-table-cell-role="th">Site 4</th>
<th data-quarto-table-cell-role="th">Site 5</th>
<th data-quarto-table-cell-role="th">min_cost</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Brighton and Hove 027E</td>
<td>3627</td>
<td>773.93</td>
<td>444.29</td>
<td>491.85</td>
<td>607.54</td>
<td>444.29</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Brighton and Hove 027F</td>
<td>2323</td>
<td>757.39</td>
<td>517.57</td>
<td>561.07</td>
<td>578.97</td>
<td>517.57</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Brighton and Hove 027A</td>
<td>2596</td>
<td>763.24</td>
<td>517.98</td>
<td>410.40</td>
<td>681.23</td>
<td>410.40</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Brighton and Hove 029E</td>
<td>3132</td>
<td>743.62</td>
<td>660.36</td>
<td>379.72</td>
<td>731.58</td>
<td>379.72</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Brighton and Hove 029D</td>
<td>2883</td>
<td>665.85</td>
<td>658.20</td>
<td>313.00</td>
<td>744.50</td>
<td>313.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">160</td>
<td>Brighton and Hove 012A</td>
<td>2497</td>
<td>446.54</td>
<td>1108.11</td>
<td>519.16</td>
<td>626.02</td>
<td>446.54</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">161</td>
<td>Brighton and Hove 005C</td>
<td>2570</td>
<td>469.80</td>
<td>1008.24</td>
<td>569.40</td>
<td>526.15</td>
<td>469.80</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">162</td>
<td>Brighton and Hove 012B</td>
<td>2051</td>
<td>464.53</td>
<td>1132.60</td>
<td>537.15</td>
<td>650.51</td>
<td>464.53</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">163</td>
<td>Brighton and Hove 005A</td>
<td>1164</td>
<td>567.49</td>
<td>1105.93</td>
<td>664.11</td>
<td>623.84</td>
<td>567.49</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">164</td>
<td>Brighton and Hove 005B</td>
<td>1097</td>
<td>495.50</td>
<td>1033.94</td>
<td>595.10</td>
<td>551.85</td>
<td>495.50</td>
</tr>
</tbody>
</table>

<p>165 rows × 7 columns</p>
</div>
</div>
</div>
</div>
<p>This line then ensures we’re just pulling out the site indices for the best sites, and filtering our site dataframe to just those.</p>
<div id="4e5435e8" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>brighton_sites_bng <span class="op">=</span> brighton_sites.to_crs(<span class="st">'EPSG:27700'</span>).iloc[best_solution[<span class="st">"site_indices"</span>].values[<span class="dv">0</span>]]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>brighton_sites_bng</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div>
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">site</th>
<th data-quarto-table-cell-role="th">geometry</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Site 1</td>
<td>POINT (527142.275 106616.053)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>Site 3</td>
<td>POINT (533356.778 105476.782)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>Site 4</td>
<td>POINT (528513.424 105052.430)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>Site 5</td>
<td>POINT (532421.163 109069.196)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</div>
</div>
<p>Now let’s do the plotting.</p>
<div id="6bb2cacb" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>best_solution_df <span class="op">=</span> pd.DataFrame(outputs).sort_values(<span class="st">'weighted_average'</span>).head(<span class="dv">1</span>)[<span class="st">'problem_df'</span>].values[<span class="dv">0</span>]</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>nearest_site_travel_brighton_gdf <span class="op">=</span> pd.merge(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    lsoa_boundaries,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    best_solution_df,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    right_on <span class="op">=</span> <span class="st">"LSOA"</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    left_on <span class="op">=</span> <span class="st">"LSOA11NM"</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>nearest_site_travel_brighton_gdf[<span class="st">"min_cost_minutes"</span>] <span class="op">=</span> nearest_site_travel_brighton_gdf[<span class="st">"min_cost"</span>] <span class="op">/</span> <span class="dv">60</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> nearest_site_travel_brighton_gdf.plot(</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"min_cost_minutes"</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">"black"</span>,</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">6</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>brighton_sites_bng <span class="op">=</span> brighton_sites.to_crs(<span class="st">'EPSG:27700'</span>).iloc[best_solution[<span class="st">"site_indices"</span>].values[<span class="dv">0</span>]]</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>hospital_points <span class="op">=</span> brighton_sites_bng.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'magenta'</span>, markersize<span class="op">=</span><span class="dv">60</span>)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>cx.add_basemap(ax, crs<span class="op">=</span>nearest_site_travel_brighton_gdf.crs.to_string(), zoom<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x, y, label <span class="kw">in</span> <span class="bu">zip</span>(brighton_sites_bng.geometry.x,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>                      brighton_sites_bng.geometry.y,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>                      brighton_sites_bng.site):</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    ax.annotate(label, xy<span class="op">=</span>(x,y), xytext<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">3</span>), textcoords<span class="op">=</span><span class="st">"offset points"</span>, bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>))</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>ax.axis(<span class="st">'off'</span>)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Travel Time (driving - minutes) for best sites in Brighton"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>Text(0.5, 1.0, 'Travel Time (driving - minutes) for best sites in Brighton')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fl_problems_coding_files/figure-html/cell-20-output-2.png" width="822" height="483" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="plotting-all-solutions" class="level3" data-number="28.2.5">
<h3 data-number="28.2.5" class="anchored" data-anchor-id="plotting-all-solutions"><span class="header-section-number">28.2.5</span> Plotting all solutions</h3>
<p>And then it doesn’t take much effort to create a map showing weighted average travel times for every possible solution!</p>
<p>The key thing is that we just iterate through our dataframe of all solutions - pulling one row out at a time.</p>
<p>If we order them by weighted average first, the map in the top left is the best solution.</p>
<p>Then it’s just our usual plot code - making sure to specify the axis we are plotting on to.</p>
<p>Another benefit of saving all these different things is that we can then easily add the weighted average travel time to the title of each plot!</p>
<div id="a9099eab" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">30</span>, <span class="dv">15</span>))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">enumerate</span>(fig.axes):</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    solution <span class="op">=</span> pd.DataFrame(outputs).sort_values(<span class="st">'weighted_average'</span>).iloc[[i]]</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    solution_df <span class="op">=</span> solution[<span class="st">'problem_df'</span>].values[<span class="dv">0</span>]</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    nearest_site_travel_brighton_gdf <span class="op">=</span> pd.merge(</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        lsoa_boundaries,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        solution_df,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        right_on <span class="op">=</span> <span class="st">"LSOA"</span>,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        left_on <span class="op">=</span> <span class="st">"LSOA11NM"</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    nearest_site_travel_brighton_gdf[<span class="st">"min_cost_minutes"</span>] <span class="op">=</span> nearest_site_travel_brighton_gdf[<span class="st">"min_cost"</span>] <span class="op">/</span> <span class="dv">60</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> nearest_site_travel_brighton_gdf.plot(</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"min_cost_minutes"</span>,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        cmap<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        edgecolor<span class="op">=</span><span class="st">"black"</span>,</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">6</span>),</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    brighton_sites_bng <span class="op">=</span> brighton_sites.to_crs(<span class="st">'EPSG:27700'</span>).iloc[solution[<span class="st">"site_indices"</span>].values[<span class="dv">0</span>]]</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    hospital_points <span class="op">=</span> brighton_sites_bng.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'magenta'</span>, markersize<span class="op">=</span><span class="dv">60</span>)</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x, y, label <span class="kw">in</span> <span class="bu">zip</span>(brighton_sites_bng.geometry.x,</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>                        brighton_sites_bng.geometry.y,</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>                        brighton_sites_bng.site):</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>        ax.annotate(label, xy<span class="op">=</span>(x,y), xytext<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">3</span>), textcoords<span class="op">=</span><span class="st">"offset points"</span>, bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>))</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    ax.axis(<span class="st">'off'</span>)</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    weighted_travel_time_solution <span class="op">=</span> solution[<span class="st">"weighted_average"</span>].values[<span class="dv">0</span>]</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    weighted_travel_time_solution_minutes <span class="op">=</span> (weighted_travel_time_solution <span class="op">/</span> <span class="dv">60</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"Weighted Average:</span><span class="ch">\n</span><span class="sc">{</span>weighted_travel_time_solution_minutes<span class="sc">}</span><span class="ss"> minutes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fl_problems_coding_files/figure-html/cell-21-output-1.png" width="2249" height="1128" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="other-ways-to-display-the-output" class="level3" data-number="28.2.6">
<h3 data-number="28.2.6" class="anchored" data-anchor-id="other-ways-to-display-the-output"><span class="header-section-number">28.2.6</span> Other ways to display the output</h3>
<p>Consider other ways to display the outputs too.</p>
<div id="5226364c" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>outputs_df <span class="op">=</span> pd.DataFrame(outputs)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>outputs_df[<span class="st">'weighted_average_minutes'</span>] <span class="op">=</span> (outputs_df[<span class="st">'weighted_average'</span>]<span class="op">/</span><span class="dv">60</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>px.bar(</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    data_frame<span class="op">=</span>outputs_df.sort_values(<span class="st">"weighted_average_minutes"</span>, ascending<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    y<span class="op">=</span><span class="st">"site_names"</span>,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    x<span class="op">=</span><span class="st">"weighted_average_minutes"</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Possible Site Combinations"</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>                            <div id="c730380a-86c3-4834-8140-d5bb73b3f7a6" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                require(["plotly"], function(Plotly) {                    window.PLOTLYENV=window.PLOTLYENV || {};                                    if (document.getElementById("c730380a-86c3-4834-8140-d5bb73b3f7a6")) {                    Plotly.newPlot(                        "c730380a-86c3-4834-8140-d5bb73b3f7a6",                        [{"alignmentgroup":"True","hovertemplate":"weighted_average_minutes=%{x}\u003cbr\u003esite_names=%{y}\u003cextra\u003e\u003c\u002fextra\u003e","legendgroup":"","marker":{"color":"#636efa","pattern":{"shape":""}},"name":"","offsetgroup":"","orientation":"h","showlegend":false,"textposition":"auto","x":[7.67,6.91,6.83,6.66,6.63,6.33,6.24,6.14,6.05,5.28,5.23,5.22,5.2,5.11,5.08],"xaxis":"x","y":["Site 1, Site 2, Site 5, Site 6","Site 1, Site 4, Site 5, Site 6","Site 1, Site 2, Site 4, Site 6","Site 2, Site 4, Site 5, Site 6","Site 1, Site 2, Site 4, Site 5","Site 2, Site 3, Site 5, Site 6","Site 1, Site 2, Site 3, Site 5","Site 1, Site 2, Site 3, Site 6","Site 1, Site 3, Site 5, Site 6","Site 2, Site 3, Site 4, Site 5","Site 1, Site 3, Site 4, Site 6","Site 1, Site 2, Site 3, Site 4","Site 2, Site 3, Site 4, Site 6","Site 3, Site 4, Site 5, Site 6","Site 1, Site 3, Site 4, Site 5"],"yaxis":"y","type":"bar"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmapgl":[{"type":"heatmapgl","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"},"margin":{"b":0,"l":0,"r":0,"t":30}}},"xaxis":{"anchor":"y","domain":[0.0,1.0],"title":{"text":"weighted_average_minutes"}},"yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"text":"site_names"}},"legend":{"tracegroupgap":0},"title":{"text":"Possible Site Combinations"},"barmode":"relative"},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('c730380a-86c3-4834-8140-d5bb73b3f7a6');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };                });            </script>        </div>
</div>
</div>
</section>
</section>
<section id="full-code-example" class="level2" data-number="28.3">
<h2 data-number="28.3" class="anchored" data-anchor-id="full-code-example"><span class="header-section-number">28.3</span> Full Code Example</h2>
<p>Finally, here is a full copyable code example for this section.</p>
<div id="5dfd0ef8" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> combinations</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Tweaked WeightedAverageObjective from Metapy package</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/health-data-science-OR/healthcare-logistics/tree/master/optimisation/metapy</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Credit: Tom Monks</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FacilityLocationObjective:</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Encapsulates logic for calculation of</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co">    metrics in a simple facility location problem</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Demand and travel matrices must have a common column</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a><span class="co">    demand: pd.dataframe:  Two column dataframe. One column should be labels for the</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="co">    demand locations (e.g. LSOA identifiers, postcodes). Second column should contain</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co">    demand figures of some kind (e.g. number of historical cases)</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="co">    If demand assumed to be equal, all values in this column could be 1.</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a><span class="co">    travel_matrix: pd.dataframe: dataframe with columns representing sites</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="co">    and rows representing locations demand will come from.</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="co">    One column should be labels for the demand locations (e.g. LSOA identifiers, postcodes).</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="co">    All other values will be either distance or time in float form.</span></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="co">    No additional columns of information must be included or they will be used as part of the</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a><span class="co">    calculation of the lowest-cost solution, which may lead to incorrect results.</span></span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, demand, travel_matrix, merge_col, demand_col):</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a><span class="co">        Store the demand and travel times</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="co">            demand: pd.DataFrame:</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a><span class="co">            travel_matrix: pd.DataFrame:</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.demand <span class="op">=</span> demand.set_index(merge_col)</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.travel_matrix <span class="op">=</span> travel_matrix.set_index(merge_col)</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.demand_col <span class="op">=</span> demand_col</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> evaluate_solution(<span class="va">self</span>, site_list):</span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a><span class="co">        Calculates the</span></span>
<span id="cb25-48"><a href="#cb25-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-49"><a href="#cb25-49" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb25-50"><a href="#cb25-50" aria-hidden="true" tabindex="-1"></a><span class="co">            site_list: list: column indices of solution to evaluate</span></span>
<span id="cb25-51"><a href="#cb25-51" aria-hidden="true" tabindex="-1"></a><span class="co">                            (to apply to travel matrix)</span></span>
<span id="cb25-52"><a href="#cb25-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-53"><a href="#cb25-53" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb25-54"><a href="#cb25-54" aria-hidden="true" tabindex="-1"></a><span class="co">            Pandas dataframe to pass to evaluation functions</span></span>
<span id="cb25-55"><a href="#cb25-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-56"><a href="#cb25-56" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb25-57"><a href="#cb25-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-58"><a href="#cb25-58" aria-hidden="true" tabindex="-1"></a>        active_facilities <span class="op">=</span> <span class="va">self</span>.travel_matrix.iloc[:, site_list].copy()</span>
<span id="cb25-59"><a href="#cb25-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-60"><a href="#cb25-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assume travel to closest facility</span></span>
<span id="cb25-61"><a href="#cb25-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Need to drop the column that contains</span></span>
<span id="cb25-62"><a href="#cb25-62" aria-hidden="true" tabindex="-1"></a>        active_facilities[<span class="st">'min_cost'</span>] <span class="op">=</span> active_facilities.<span class="bu">min</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-63"><a href="#cb25-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-64"><a href="#cb25-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-65"><a href="#cb25-65" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge demand and travel times into a single DataFrame</span></span>
<span id="cb25-66"><a href="#cb25-66" aria-hidden="true" tabindex="-1"></a>        problem <span class="op">=</span> <span class="va">self</span>.demand.merge(active_facilities,</span>
<span id="cb25-67"><a href="#cb25-67" aria-hidden="true" tabindex="-1"></a>                                    left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb25-68"><a href="#cb25-68" aria-hidden="true" tabindex="-1"></a>                                    how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb25-69"><a href="#cb25-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-70"><a href="#cb25-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> problem.reset_index()</span>
<span id="cb25-71"><a href="#cb25-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-72"><a href="#cb25-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-73"><a href="#cb25-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> generate_solution_metrics(<span class="va">self</span>, site_list):</span>
<span id="cb25-74"><a href="#cb25-74" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb25-75"><a href="#cb25-75" aria-hidden="true" tabindex="-1"></a><span class="co">        Calculates the weighted average travel time for selected sites</span></span>
<span id="cb25-76"><a href="#cb25-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-77"><a href="#cb25-77" aria-hidden="true" tabindex="-1"></a><span class="co">        Args:</span></span>
<span id="cb25-78"><a href="#cb25-78" aria-hidden="true" tabindex="-1"></a><span class="co">            site_list: list or np.array: A list of site IDs as a list or array (e.g. [0, 3, 4])</span></span>
<span id="cb25-79"><a href="#cb25-79" aria-hidden="true" tabindex="-1"></a><span class="co">            merge_col: string: The column name to use for merging the data.</span></span>
<span id="cb25-80"><a href="#cb25-80" aria-hidden="true" tabindex="-1"></a><span class="co">            n_patients_or_referrals_col: string: The column name to use for the number of patients or referrals.</span></span>
<span id="cb25-81"><a href="#cb25-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-82"><a href="#cb25-82" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns:</span></span>
<span id="cb25-83"><a href="#cb25-83" aria-hidden="true" tabindex="-1"></a><span class="co">            A tuple containing the problem and the maximum travel time.</span></span>
<span id="cb25-84"><a href="#cb25-84" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb25-85"><a href="#cb25-85" aria-hidden="true" tabindex="-1"></a>        problem <span class="op">=</span> <span class="va">self</span>.evaluate_solution(site_list)</span>
<span id="cb25-86"><a href="#cb25-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-87"><a href="#cb25-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return weighted average</span></span>
<span id="cb25-88"><a href="#cb25-88" aria-hidden="true" tabindex="-1"></a>        weighted_average <span class="op">=</span> np.average(problem[<span class="st">'min_cost'</span>], weights<span class="op">=</span>problem[<span class="va">self</span>.demand_col])</span>
<span id="cb25-89"><a href="#cb25-89" aria-hidden="true" tabindex="-1"></a>        unweighted_average <span class="op">=</span> np.average(problem[<span class="st">'min_cost'</span>])</span>
<span id="cb25-90"><a href="#cb25-90" aria-hidden="true" tabindex="-1"></a>        max_travel <span class="op">=</span> np.<span class="bu">max</span>(problem[<span class="st">'min_cost'</span>])</span>
<span id="cb25-91"><a href="#cb25-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-92"><a href="#cb25-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb25-93"><a href="#cb25-93" aria-hidden="true" tabindex="-1"></a>            <span class="st">'site_indices'</span>: site_list,</span>
<span id="cb25-94"><a href="#cb25-94" aria-hidden="true" tabindex="-1"></a>            <span class="st">'site_names'</span>: <span class="st">", "</span>.join(<span class="va">self</span>.travel_matrix.columns[site_list].tolist()),</span>
<span id="cb25-95"><a href="#cb25-95" aria-hidden="true" tabindex="-1"></a>            <span class="st">'weighted_average'</span>: weighted_average,</span>
<span id="cb25-96"><a href="#cb25-96" aria-hidden="true" tabindex="-1"></a>            <span class="st">'unweighted_average'</span>: unweighted_average,</span>
<span id="cb25-97"><a href="#cb25-97" aria-hidden="true" tabindex="-1"></a>            <span class="st">'max'</span>: max_travel,</span>
<span id="cb25-98"><a href="#cb25-98" aria-hidden="true" tabindex="-1"></a>            <span class="st">'problem_df'</span>: problem</span>
<span id="cb25-99"><a href="#cb25-99" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb25-100"><a href="#cb25-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-101"><a href="#cb25-101" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> all_combinations(n_facilities, p):</span>
<span id="cb25-102"><a href="#cb25-102" aria-hidden="true" tabindex="-1"></a>    facility <span class="op">=</span> np.arange(n_facilities, dtype<span class="op">=</span>np.uint8)</span>
<span id="cb25-103"><a href="#cb25-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [np.array(a) <span class="cf">for</span> a <span class="kw">in</span> combinations(facility, p)]</span>
<span id="cb25-104"><a href="#cb25-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-105"><a href="#cb25-105" aria-hidden="true" tabindex="-1"></a>brighton_demand <span class="op">=</span> pd.read_csv(<span class="st">"https://raw.githubusercontent.com/hsma-programme/h6_3d_facility_location_problems/main/h6_3d_facility_location_problems/example_code/brighton_demand.csv"</span>).drop(columns<span class="op">=</span>[<span class="st">"Unnamed: 0"</span>])</span>
<span id="cb25-106"><a href="#cb25-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-107"><a href="#cb25-107" aria-hidden="true" tabindex="-1"></a>brighton_sites <span class="op">=</span> geopandas.read_file(<span class="st">"https://raw.githubusercontent.com/hsma-programme/h6_3d_facility_location_problems/main/h6_3d_facility_location_problems/example_code/brighton_sites.geojson"</span>)</span>
<span id="cb25-108"><a href="#cb25-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-109"><a href="#cb25-109" aria-hidden="true" tabindex="-1"></a>brighton_travel <span class="op">=</span> pd.read_csv(<span class="st">"https://raw.githubusercontent.com/hsma-programme/h6_3d_facility_location_problems/main/h6_3d_facility_location_problems/example_code/brighton_travel_matrix_driving.csv"</span>).drop(columns<span class="op">=</span>[<span class="st">"Unnamed: 0"</span>])</span>
<span id="cb25-110"><a href="#cb25-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-111"><a href="#cb25-111" aria-hidden="true" tabindex="-1"></a>lsoa_boundaries <span class="op">=</span> geopandas.read_file(<span class="st">"https://raw.githubusercontent.com/hsma-programme/h6_3d_facility_location_problems/main/h6_3d_facility_location_problems/example_code/LSOA_2011_Boundaries_Super_Generalised_Clipped_BSC_EW_V4.geojson"</span>)</span>
<span id="cb25-112"><a href="#cb25-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-113"><a href="#cb25-113" aria-hidden="true" tabindex="-1"></a>location_problem_brighton <span class="op">=</span> FacilityLocationObjective(</span>
<span id="cb25-114"><a href="#cb25-114" aria-hidden="true" tabindex="-1"></a>    demand<span class="op">=</span>brighton_demand,</span>
<span id="cb25-115"><a href="#cb25-115" aria-hidden="true" tabindex="-1"></a>    travel_matrix<span class="op">=</span>brighton_travel,</span>
<span id="cb25-116"><a href="#cb25-116" aria-hidden="true" tabindex="-1"></a>    merge_col<span class="op">=</span><span class="st">"LSOA"</span>,</span>
<span id="cb25-117"><a href="#cb25-117" aria-hidden="true" tabindex="-1"></a>    demand_col<span class="op">=</span><span class="st">"demand"</span></span>
<span id="cb25-118"><a href="#cb25-118" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-119"><a href="#cb25-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-120"><a href="#cb25-120" aria-hidden="true" tabindex="-1"></a>possible_combinations_brighton <span class="op">=</span> all_combinations(</span>
<span id="cb25-121"><a href="#cb25-121" aria-hidden="true" tabindex="-1"></a>    <span class="bu">len</span>(location_problem_brighton.travel_matrix.columns),</span>
<span id="cb25-122"><a href="#cb25-122" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span></span>
<span id="cb25-123"><a href="#cb25-123" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-124"><a href="#cb25-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-125"><a href="#cb25-125" aria-hidden="true" tabindex="-1"></a>outputs <span class="op">=</span> []</span>
<span id="cb25-126"><a href="#cb25-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-127"><a href="#cb25-127" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> possible_solution <span class="kw">in</span> possible_combinations_brighton:</span>
<span id="cb25-128"><a href="#cb25-128" aria-hidden="true" tabindex="-1"></a>    outputs.append(</span>
<span id="cb25-129"><a href="#cb25-129" aria-hidden="true" tabindex="-1"></a>        location_problem_brighton.generate_solution_metrics(</span>
<span id="cb25-130"><a href="#cb25-130" aria-hidden="true" tabindex="-1"></a>        possible_solution</span>
<span id="cb25-131"><a href="#cb25-131" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-132"><a href="#cb25-132" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-133"><a href="#cb25-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-134"><a href="#cb25-134" aria-hidden="true" tabindex="-1"></a>best_solution <span class="op">=</span> pd.DataFrame(outputs).sort_values(<span class="st">'weighted_average'</span>).head(<span class="dv">1</span>)</span>
<span id="cb25-135"><a href="#cb25-135" aria-hidden="true" tabindex="-1"></a>best_solution_df <span class="op">=</span> best_solution[<span class="st">'problem_df'</span>].values[<span class="dv">0</span>]</span>
<span id="cb25-136"><a href="#cb25-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-137"><a href="#cb25-137" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">30</span>, <span class="dv">15</span>))</span>
<span id="cb25-138"><a href="#cb25-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-139"><a href="#cb25-139" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">enumerate</span>(fig.axes):</span>
<span id="cb25-140"><a href="#cb25-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-141"><a href="#cb25-141" aria-hidden="true" tabindex="-1"></a>    solution <span class="op">=</span> pd.DataFrame(outputs).sort_values(<span class="st">'weighted_average'</span>).iloc[[i]]</span>
<span id="cb25-142"><a href="#cb25-142" aria-hidden="true" tabindex="-1"></a>    solution_df <span class="op">=</span> solution[<span class="st">'problem_df'</span>].values[<span class="dv">0</span>]</span>
<span id="cb25-143"><a href="#cb25-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-144"><a href="#cb25-144" aria-hidden="true" tabindex="-1"></a>    nearest_site_travel_brighton_gdf <span class="op">=</span> pd.merge(</span>
<span id="cb25-145"><a href="#cb25-145" aria-hidden="true" tabindex="-1"></a>        lsoa_boundaries,</span>
<span id="cb25-146"><a href="#cb25-146" aria-hidden="true" tabindex="-1"></a>        solution_df,</span>
<span id="cb25-147"><a href="#cb25-147" aria-hidden="true" tabindex="-1"></a>        right_on <span class="op">=</span> <span class="st">"LSOA"</span>,</span>
<span id="cb25-148"><a href="#cb25-148" aria-hidden="true" tabindex="-1"></a>        left_on <span class="op">=</span> <span class="st">"LSOA11NM"</span></span>
<span id="cb25-149"><a href="#cb25-149" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-150"><a href="#cb25-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-151"><a href="#cb25-151" aria-hidden="true" tabindex="-1"></a>    nearest_site_travel_brighton_gdf[<span class="st">"min_cost_minutes"</span>] <span class="op">=</span> nearest_site_travel_brighton_gdf[<span class="st">"min_cost"</span>] <span class="op">/</span> <span class="dv">60</span></span>
<span id="cb25-152"><a href="#cb25-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-153"><a href="#cb25-153" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> nearest_site_travel_brighton_gdf.plot(</span>
<span id="cb25-154"><a href="#cb25-154" aria-hidden="true" tabindex="-1"></a>        <span class="st">"min_cost_minutes"</span>,</span>
<span id="cb25-155"><a href="#cb25-155" aria-hidden="true" tabindex="-1"></a>        legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb25-156"><a href="#cb25-156" aria-hidden="true" tabindex="-1"></a>        cmap<span class="op">=</span><span class="st">"Blues"</span>,</span>
<span id="cb25-157"><a href="#cb25-157" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb25-158"><a href="#cb25-158" aria-hidden="true" tabindex="-1"></a>        edgecolor<span class="op">=</span><span class="st">"black"</span>,</span>
<span id="cb25-159"><a href="#cb25-159" aria-hidden="true" tabindex="-1"></a>        linewidth<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb25-160"><a href="#cb25-160" aria-hidden="true" tabindex="-1"></a>        figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">6</span>),</span>
<span id="cb25-161"><a href="#cb25-161" aria-hidden="true" tabindex="-1"></a>        ax<span class="op">=</span>ax</span>
<span id="cb25-162"><a href="#cb25-162" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-163"><a href="#cb25-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-164"><a href="#cb25-164" aria-hidden="true" tabindex="-1"></a>    brighton_sites_bng <span class="op">=</span> brighton_sites.to_crs(<span class="st">'EPSG:27700'</span>).iloc[solution[<span class="st">"site_indices"</span>].values[<span class="dv">0</span>]]</span>
<span id="cb25-165"><a href="#cb25-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-166"><a href="#cb25-166" aria-hidden="true" tabindex="-1"></a>    hospital_points <span class="op">=</span> brighton_sites_bng.plot(ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">'magenta'</span>, markersize<span class="op">=</span><span class="dv">60</span>)</span>
<span id="cb25-167"><a href="#cb25-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-168"><a href="#cb25-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> x, y, label <span class="kw">in</span> <span class="bu">zip</span>(brighton_sites_bng.geometry.x,</span>
<span id="cb25-169"><a href="#cb25-169" aria-hidden="true" tabindex="-1"></a>                        brighton_sites_bng.geometry.y,</span>
<span id="cb25-170"><a href="#cb25-170" aria-hidden="true" tabindex="-1"></a>                        brighton_sites_bng.site):</span>
<span id="cb25-171"><a href="#cb25-171" aria-hidden="true" tabindex="-1"></a>        ax.annotate(label, xy<span class="op">=</span>(x,y), xytext<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">3</span>), textcoords<span class="op">=</span><span class="st">"offset points"</span>, bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>))</span>
<span id="cb25-172"><a href="#cb25-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-173"><a href="#cb25-173" aria-hidden="true" tabindex="-1"></a>    ax.axis(<span class="st">'off'</span>)</span>
<span id="cb25-174"><a href="#cb25-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-175"><a href="#cb25-175" aria-hidden="true" tabindex="-1"></a>    weighted_travel_time_solution <span class="op">=</span> solution[<span class="st">"weighted_average"</span>].values[<span class="dv">0</span>]</span>
<span id="cb25-176"><a href="#cb25-176" aria-hidden="true" tabindex="-1"></a>    weighted_travel_time_solution_minutes <span class="op">=</span> (weighted_travel_time_solution <span class="op">/</span> <span class="dv">60</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb25-177"><a href="#cb25-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-178"><a href="#cb25-178" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="ss">f"Weighted Average:</span><span class="ch">\n</span><span class="sc">{</span>weighted_travel_time_solution_minutes<span class="sc">}</span><span class="ss"> minutes"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="fl_problems_coding_files/figure-html/cell-23-output-1.png" width="2249" height="1128" class="figure-img"></p>
</figure>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script>

/* update total correct if #webex-total_correct exists */
update_total_correct = function() {
  console.log("webex: update total_correct");

  var t = document.getElementsByClassName("webex-total_correct");
  for (var i = 0; i < t.length; i++) {
    p = t[i].parentElement;
    var correct = p.getElementsByClassName("webex-correct").length;
    var solvemes = p.getElementsByClassName("webex-solveme").length;
    var radiogroups = p.getElementsByClassName("webex-radiogroup").length;
    var selects = p.getElementsByClassName("webex-select").length;

    t[i].innerHTML = correct + " of " + (solvemes + radiogroups + selects) + " correct";
  }
}

/* webex-solution button toggling function */
b_func = function() {
  console.log("webex: toggle hide");

  var cl = this.parentElement.classList;
  if (cl.contains('open')) {
    cl.remove("open");
  } else {
    cl.add("open");
  }
}

/* check answers */
check_func = function() {
  console.log("webex: check answers");
  console.log(document.getElementsByClassName("webex-check"));

  var cl = this.parentElement.classList;
  if (cl.contains('unchecked')) {
    cl.remove("unchecked");
    this.innerHTML = "Hide Answers";

    check_answer_box_nodelist = this.parentNode.childNodes
    console.log(check_answer_box_nodelist)
    for (let i = 0; i < check_answer_box_nodelist.length; i++) {
      var cl_inner = check_answer_box_nodelist[i].classList;
      console.log("Nodelist", i, ":", cl_inner);
      if (typeof cl_inner !== "undefined")
        {
          if (cl_inner.contains("feedback")) {
            {/* console.log(cl_inner.contains("feedback")) */}
            {/* console.log(check_answer_box_nodelist[i].style.display) */}
            check_answer_box_nodelist[i].style.display = "block"
          }
        }

      }

  } else {
    cl.add("unchecked");
    this.innerHTML = "Show Answers";

    check_answer_box_nodelist = this.parentNode.childNodes
    console.log(check_answer_box_nodelist)
    for (let i = 0; i < check_answer_box_nodelist.length; i++) {
      var cl_inner = check_answer_box_nodelist[i].classList;
      console.log("Nodelist", i, ":", cl_inner);
      if (typeof cl_inner !== "undefined")
        {
          if (cl_inner.contains("feedback")) {
            {/* console.log(cl_inner.contains("feedback")) */}
            {/* console.log(check_answer_box_nodelist[i].style.display) */}
            check_answer_box_nodelist[i].style.display = "none"
          }
        }

      }

  }

}

/* function for checking solveme answers */
solveme_func = function(e) {
  console.log("webex: check solveme");
  {/* console.log(e) */}
  {/* console.log(this) */}

  var real_answers = JSON.parse(this.dataset.answer);
  var my_answer = this.value;
  var cl = this.classList;

  var feedback = (this.getAttribute("feedback"))

  if (document.getElementById('feedbackDiv'+this.id) === null){

    var feedbackDiv = document.createElement("p");
    feedbackDiv.setAttribute("id", "feedbackDiv"+this.id);
    feedbackDiv.setAttribute("class", "feedback");

  } else {

    var feedbackDiv = document.getElementById('feedbackDiv'+this.id)
    feedbackDiv.innerHTML = "";

  }

  // Check if inside a 'check answers' box - if so and if answer box is
  // currently unchecked, ensure feedback is hidden
  if (this.parentElement.parentElement.classList.contains("unchecked")) {
    {/* console.log(this.parentElement.parentElement.classList); */}
    feedbackDiv.style.display = "none"
  } else {
    {/* console.log(this.parentElement.parentElement.classList); */}
    feedbackDiv.style.display = "block"
  }

  if (cl.contains("ignorecase")) {
    my_answer = my_answer.toLowerCase();
  }
  if (cl.contains("nospaces")) {
    my_answer = my_answer.replace(/ /g, "")
  }

  if (my_answer == "") {
    cl.remove("webex-correct");
    cl.remove("webex-incorrect");
  } else if (real_answers.includes(my_answer)) {
    cl.add("webex-correct");
    cl.remove("webex-incorrect");
  } else {
    cl.add("webex-incorrect");
    cl.remove("webex-correct");
    feedbackDiv.innerHTML = feedback;
  	this.parentNode.insertAdjacentElement('afterend', feedbackDiv);
  }

  // match numeric answers within a specified tolerance
  if(this.dataset.tol > 0){
    var tol = JSON.parse(this.dataset.tol);
    var matches = real_answers.map(x => Math.abs(x - my_answer) < tol)
    if (matches.reduce((a, b) => a + b, 0) > 0) {
      cl.add("webex-correct");
    } else {
      cl.remove("webex-correct");
      feedbackDiv.innerHTML = feedback;
  	  this.parentNode.insertAdjacentElement('afterend', feedbackDiv);
    }
  }

  // added regex bit
  if (cl.contains("regex")){
    answer_regex = RegExp(real_answers.join("|"))
    if (answer_regex.test(my_answer)) {
      cl.add("webex-correct");
    }
  }

  update_total_correct();
}

/* function for checking select answers */
select_func = function(e) {
  console.log("webex: check select");

  var cl = this.classList
  var feedback = (this[this.selectedIndex].getAttribute("feedback"))

  if (document.getElementById('feedbackDiv'+this.id) === null){

    var feedbackDiv = document.createElement("p");
    feedbackDiv.setAttribute("id", "feedbackDiv"+this.id);
    feedbackDiv.setAttribute("class", "feedback");

  } else {

    var feedbackDiv = document.getElementById('feedbackDiv'+this.id)
    feedbackDiv.innerHTML = "";

  }

  feedbackDiv.innerHTML = feedback;
  this.parentNode.insertAdjacentElement('afterend', feedbackDiv);

  // Check if inside a 'check answers' box - if so and if answer box is
  // currently unchecked, ensure feedback is hidden
  if (this.parentElement.parentElement.classList.contains("unchecked")) {
    {/* console.log(this.parentElement.parentElement.classList); */}
    feedbackDiv.style.display = "none"
  } else {
    {/* console.log(this.parentElement.parentElement.classList); */}
    feedbackDiv.style.display = "block"
  }

  /* add style */
  cl.remove("webex-incorrect");
  cl.remove("webex-correct");
  if (this.value == "answer") {
    cl.add("webex-correct");
  } else if (this.value != "blank") {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

/* function for checking radiogroups answers */
radiogroups_func = function(e) {
  console.log("webex: check radiogroups");

  var checked_button = document.querySelector('input[name=' + this.id + ']:checked');
  var cl = checked_button.parentElement.classList;
  var labels = checked_button.parentElement.parentElement.children;
  var feedback = (checked_button.getAttribute("feedback"))
  if (feedback !== null & feedback !== "<b></b>") { feedback = feedback + "</br></br>" }

  if (document.getElementById('feedbackDiv'+this.id) === null){

    var feedbackDiv = document.createElement("div");
    feedbackDiv.setAttribute("id", "feedbackDiv"+this.id);
    feedbackDiv.setAttribute("class", "feedback");

  } else {

      var feedbackDiv = document.getElementById('feedbackDiv'+this.id)
      feedbackDiv.innerHTML = "";

  }

  const currentDiv = document.getElementById(this);
  feedbackDiv.innerHTML = feedback;
  this.insertAdjacentElement('afterend', feedbackDiv);

    // Check if inside a 'check answers' box - if so and if answer box is
  // currently unchecked, ensure feedback is hidden
  if (this.parentElement.classList.contains("unchecked")) {
      {/* console.log(this.parentElement.parentElement.classList); */}
      feedbackDiv.style.display = "none"
    } else {
      {/* console.log(this.parentElement.parentElement.classList); */}
      feedbackDiv.style.display = "block"
    }


  /* get rid of styles */
  for (i = 0; i < labels.length; i++) {
    labels[i].classList.remove("webex-incorrect");
    labels[i].classList.remove("webex-correct");
  }

  /* add style */
  if (checked_button.value == "answer") {
    cl.add("webex-correct");
  } else {
    cl.add("webex-incorrect");
  }

  update_total_correct();
}

window.onload = function() {
  console.log("webex onload");
  /* set up solution buttons */
  var buttons = document.getElementsByTagName("button");

  for (var i = 0; i < buttons.length; i++) {
    if (buttons[i].parentElement.classList.contains('webex-solution')) {
      buttons[i].onclick = b_func;
    }
  }

  var check_sections = document.getElementsByClassName("webex-check");
  console.log("check:", check_sections.length);
  for (var i = 0; i < check_sections.length; i++) {
    check_sections[i].classList.add("unchecked");
    console.log(check_sections[i])

    let btn = document.createElement("button");
    btn.innerHTML = "Show Answers";
    btn.classList.add("webex-check-button");
    // check_func removes the 'unchecked' class from box
    // and updates the button text
    // subsequently recheck all possible question funcs
    // to ensure feedback gets shown or hidden as appropriate
    btn.onclick = check_func;

    check_sections[i].appendChild(btn);

    let spn = document.createElement("span");
    spn.classList.add("webex-total_correct");
    check_sections[i].appendChild(spn);
  }

  /* set up webex-solveme inputs */
  var solveme = document.getElementsByClassName("webex-solveme");

  for (var i = 0; i < solveme.length; i++) {
    /* make sure input boxes don't auto-anything */
    solveme[i].setAttribute("autocomplete","off");
    solveme[i].setAttribute("autocorrect", "off");
    solveme[i].setAttribute("autocapitalize", "off");
    solveme[i].setAttribute("spellcheck", "false");
    solveme[i].value = "";

    /* adjust answer for ignorecase or nospaces */
    var cl = solveme[i].classList;
    var real_answer = solveme[i].dataset.answer;
    if (cl.contains("ignorecase")) {
      real_answer = real_answer.toLowerCase();
    }
    if (cl.contains("nospaces")) {
      real_answer = real_answer.replace(/ /g, "");
    }
    solveme[i].dataset.answer = real_answer;

    /* attach checking function */
    solveme[i].onkeyup = solveme_func;
    solveme[i].onchange = solveme_func;

    solveme[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  /* set up radiogroups */
  var radiogroups = document.getElementsByClassName("webex-radiogroup");
  for (var i = 0; i < radiogroups.length; i++) {
    radiogroups[i].onchange = radiogroups_func;
  }

  /* set up selects */
  var selects = document.getElementsByClassName("webex-select");
  for (var i = 0; i < selects.length; i++) {
    selects[i].onchange = select_func;
    selects[i].insertAdjacentHTML("afterend", " <span class='webex-icon'></span>")
  }

  update_total_correct();
}

</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./fl_site_combinations.html" class="pagination-link" aria-label="Calculating combinations of sites">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Calculating combinations of sites</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->




</body></html>